<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Teste Unitário - Bone Holding Forceps</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Segoe UI', sans-serif; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;
            display: flex; flex-direction: column;
        }

        #header {
            background: linear-gradient(180deg, rgba(0,0,0,0.9) 0%, transparent 100%);
            color: #fff; padding: 20px; text-align: center; pointer-events: auto;
        }
        
        #info-card {
            position: absolute; bottom: 30px; right: 30px; width: 300px;
            background: rgba(20, 30, 25, 0.95); 
            border-left: 4px solid #4CAF50;
            backdrop-filter: blur(10px);
            color: #fff; padding: 20px; border-radius: 4px;
            display: none; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            pointer-events: auto;
        }

        #info-card h3 { margin: 0 0 5px 0; color: #4CAF50; font-size: 18px; }
        #info-card p { font-size: 14px; color: #ccc; line-height: 1.5; }

        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #4CAF50; font-size: 18px; font-weight: bold;
            background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 30px;
        }
    </style>
</head>
<body>

    <div id="loading">CARREGANDO ARQUIVO GLB...</div>

    <div id="ui-layer">
        <div id="header">
            <h2>TESTE DE RENDERIZAÇÃO</h2>
            <p style="color: #888; margin: 0;">Leo Bone Holding Forceps 1</p>
        </div>

        <div id="info-card">
            <h3 id="card-title">Nome</h3>
            <p id="card-desc">Descrição...</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // CONFIGURAÇÃO DO SEU ARQUIVO DE TESTE
        const testFile = {
            file: 'Leo Bone Holding Forceps 1 SharpFusion.glb', // Nome exato do arquivo
            name: 'Bone Holding Forceps (Pinça de Osso)',
            desc: 'Instrumento robusto utilizado em ortopedia para segurar e estabilizar fragmentos ósseos durante a redução de fraturas ou fixação de placas.'
        };

        let scene, camera, renderer, controls, raycaster, mouse;
        let loadedObject = null;

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222);
            
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 10); // Posição da câmera

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.outputEncoding = THREE.sRGBEncoding; // Importante para GLB ficar com cor certa
            document.body.appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // Luzes
            const ambient = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // Mesa Verde
            const tableGeo = new THREE.PlaneGeometry(20, 20);
            const tableMat = new THREE.MeshStandardMaterial({ color: 0x2e8b57, roughness: 0.8 });
            const table = new THREE.Mesh(tableGeo, tableMat);
            table.rotation.x = -Math.PI / 2;
            table.receiveShadow = true;
            scene.add(table);

            // Carregar o Modelo
            loadModel();

            // Interação
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();
            window.addEventListener('resize', onResize);
            window.addEventListener('pointerup', onClick);
        }

        function loadModel() {
            const loader = new THREE.GLTFLoader();
            const path = './models/' + testFile.file;

            loader.load(path, function (gltf) {
                const model = gltf.scene;
                
                // Centraliza e ajusta escala
                // GLBs médicos as vezes vêm fora de escala (metros vs mm)
                const box = new THREE.Box3().setFromObject(model);
                const size = new THREE.Vector3();
                box.getSize(size);
                
                // Se o objeto for muito grande (> 10 unidades) ou muito pequeno (< 0.5), normaliza para tamanho 4
                const maxDim = Math.max(size.x, size.y, size.z);
                const scaleFactor = 4.0 / maxDim;
                
                model.scale.set(scaleFactor, scaleFactor, scaleFactor);
                
                // Posiciona na mesa
                model.position.set(0, 0.5, 0); 
                
                // Tenta corrigir rotação (muitos vêm em pé)
                model.rotation.x = -Math.PI / 2; // Deita na mesa
                // Se ficar torto, tente remover a linha acima ou mudar para Math.PI/2

                model.traverse((child) => {
                    if (child.isMesh) {
                        child.castShadow = true;
                        child.receiveShadow = true;
                        // Força um material metálico se o GLB não tiver textura boa
                        child.material.metalness = 0.8;
                        child.material.roughness = 0.3;
                    }
                });

                scene.add(model);
                loadedObject = model;
                
                document.getElementById('loading').style.display = 'none';

            }, undefined, function (error) {
                console.error(error);
                document.getElementById('loading').innerText = "ERRO: Arquivo não encontrado na pasta /models";
                document.getElementById('loading').style.color = "red";
            });
        }

        function onClick(event) {
            if(!loadedObject) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            // Verifica interseção recursiva (true) pois GLB é um grupo de malhas
            const intersects = raycaster.intersectObjects([loadedObject], true);

            if (intersects.length > 0) {
                // Animação de "Pulo"
                loadedObject.position.y = 3.0;
                loadedObject.rotation.z += 1.0; 
                loadedObject.rotation.x = 0; // Fica em pé para ver melhor

                // Mostra Info
                const card = document.getElementById('info-card');
                card.style.display = 'block';
                document.getElementById('card-title').innerText = testFile.name;
                document.getElementById('card-desc').innerText = testFile.desc;
            } else {
                // Reseta
                loadedObject.position.y = 0.5;
                loadedObject.rotation.x = -Math.PI / 2; // Volta a deitar
                document.getElementById('info-card').style.display = 'none';
            }
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(loadedObject && loadedObject.position.y > 1) {
                // Gira suavemente enquanto está selecionado
                loadedObject.rotation.y += 0.01;
            }
            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
