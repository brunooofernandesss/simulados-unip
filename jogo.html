<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Mesa Cirúrgica – Visualizador Profissional</title>

<style>
body {
    margin: 0;
    overflow: hidden;
    background: #0f0f0f;
    font-family: "Segoe UI", system-ui, sans-serif;
}

/* UI */
#ui {
    position: absolute;
    inset: 0;
    pointer-events: none;
    z-index: 10;
}

#topbar {
    padding: 18px;
    text-align: center;
    background: linear-gradient(180deg, rgba(0,0,0,.85), transparent);
    color: #eaeaea;
    pointer-events: auto;
}

#topbar h2 {
    margin: 0;
    letter-spacing: 2px;
    font-size: 18px;
}

#topbar span {
    font-size: 11px;
    color: #aaa;
}

#info {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    width: min(92%, 420px);
    background: rgba(12,12,12,.95);
    border-top: 3px solid #2ecc71;
    border-radius: 10px;
    padding: 18px;
    display: none;
    pointer-events: auto;
    box-shadow: 0 20px 50px rgba(0,0,0,.9);
}

#info h3 {
    margin: 0 0 8px;
    color: #2ecc71;
    text-transform: uppercase;
    font-size: 16px;
}

#info p {
    font-size: 14px;
    line-height: 1.6;
    color: #ddd;
}

#hint {
    font-size: 11px;
    margin-top: 12px;
    color: #777;
}

#back {
    position: absolute;
    top: 18px;
    left: 18px;
    pointer-events: auto;
    background: rgba(255,255,255,.08);
    color: white;
    border: 1px solid rgba(255,255,255,.25);
    padding: 8px 14px;
    border-radius: 6px;
    cursor: pointer;
    display: none;
}

#loading {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    color: #2ecc71;
    font-weight: bold;
    background: #000;
    z-index: 50;
}
</style>
</head>

<body>

<div id="loading">CARREGANDO INSTRUMENTOS...</div>

<div id="ui">
    <div id="topbar">
        <h2>MESA DE INSTRUMENTAÇÃO</h2>
        <span>Toque em um instrumento para inspeção</span>
    </div>

    <button id="back">⬅ VOLTAR</button>

    <div id="info">
        <h3 id="info-title"></h3>
        <p id="info-desc"></p>
        <div id="hint">Use dois dedos para zoom</div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128/examples/js/controls/OrbitControls.js"></script>

<script>
/* ================= CONFIG ================= */

const instruments = [
{
    file: "Leo Bone Holding Forceps 1 SharpFusion.glb",
    name: "Bone Holding Forceps",
    desc: "Pinça de redução óssea usada para estabilização de fragmentos durante cirurgias ortopédicas. Possui cremalheira para travamento firme."
}
];

const CAM_TABLE = new THREE.Vector3(0, 14, 12);
const CAM_INSPECT = new THREE.Vector3(0, 4, 7);

/* ================= CORE ================= */

let scene, camera, renderer, controls;
let raycaster = new THREE.Raycaster();
let mouse = new THREE.Vector2();

let objects = [];
let current = null;
let inspecting = false;
let transitioning = false;
let targetCam = new THREE.Vector3();
let targetLook = new THREE.Vector3();

/* ================= INIT ================= */

init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f0f0f);

    camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 1000);
    camera.position.copy(CAM_TABLE);

    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio,2));
    renderer.shadowMap.enabled = true;
    renderer.outputEncoding = THREE.sRGBEncoding;
    document.body.appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.enablePan = false;
    controls.minDistance = 2;
    controls.maxDistance = 20;
    controls.maxPolarAngle = Math.PI / 2.05;

    /* Luz cirúrgica */
    scene.add(new THREE.AmbientLight(0xffffff,.4));

    const spot = new THREE.SpotLight(0xffffff,1.4);
    spot.position.set(5,18,8);
    spot.castShadow = true;
    scene.add(spot);

    const rim = new THREE.PointLight(0x3366ff,.4);
    rim.position.set(-6,4,-6);
    scene.add(rim);

    /* Mesa */
    const table = new THREE.Mesh(
        new THREE.PlaneGeometry(40,40),
        new THREE.MeshStandardMaterial({color:0x2f7f5f, roughness:.9})
    );
    table.rotation.x = -Math.PI/2;
    table.receiveShadow = true;
    scene.add(table);

    loadInstruments();

    window.addEventListener("resize", onResize);
    window.addEventListener("pointerup", onClick);
    document.getElementById("back").onclick = exitInspection;
}

function loadInstruments() {
    const loader = new THREE.GLTFLoader();

    loader.load("./models/"+instruments[0].file, gltf=>{
        const obj = gltf.scene;
        normalize(obj);
        scene.add(obj);
        objects.push({ mesh: obj, data: instruments[0] });
        document.getElementById("loading").style.display="none";
    });
}

function normalize(model) {
    const box = new THREE.Box3().setFromObject(model);
    const size = box.getSize(new THREE.Vector3());
    const scale = 6 / Math.max(size.x,size.y,size.z);
    model.scale.setScalar(scale);

    model.position.y = -box.min.y * scale + .1;
    model.rotation.x = -Math.PI/2;

    model.traverse(m=>{
        if(m.isMesh){
            m.castShadow = true;
            m.material.metalness = .7;
            m.material.roughness = .3;
        }
    });
}

function onClick(e){
    if(transitioning) return;

    mouse.x = (e.clientX/innerWidth)*2-1;
    mouse.y = -(e.clientY/innerHeight)*2+1;
    raycaster.setFromCamera(mouse,camera);

    const hits = raycaster.intersectObjects(objects.map(o=>o.mesh),true);
    if(hits.length && !inspecting){
        enterInspection(objects[0]);
    } else if(inspecting){
        exitInspection();
    }
}

function enterInspection(obj){
    inspecting = true;
    transitioning = true;
    current = obj;

    obj.mesh.position.set(0,0,0);
    obj.mesh.rotation.set(0,0,0);

    targetCam.copy(CAM_INSPECT);
    targetLook.set(0,0,0);

    document.getElementById("info").style.display="block";
    document.getElementById("back").style.display="block";
    document.getElementById("info-title").innerText=obj.data.name;
    document.getElementById("info-desc").innerText=obj.data.desc;
}

function exitInspection(){
    inspecting=false;
    transitioning=true;

    targetCam.copy(CAM_TABLE);
    targetLook.set(0,0,0);

    document.getElementById("info").style.display="none";
    document.getElementById("back").style.display="none";
}

function animate(){
    requestAnimationFrame(animate);

    if(transitioning){
        camera.position.lerp(targetCam,.08);
        controls.target.lerp(targetLook,.08);
        if(camera.position.distanceTo(targetCam)<.1) transitioning=false;
    } else controls.update();

    renderer.render(scene,camera);
}

function onResize(){
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
}
</script>
</body>
</html>
